!function(g){"use strict";var y=function(t){var e=g.Deferred(),n=new FileReader;return n.onload=function(t){e.resolve(t.target.result)},n.onerror=e.reject,n.onprogress=e.notify,n.readAsDataURL(t),e.promise()};g.fn.cleanHtml=function(t){if(!0===g(this).data("wysiwyg-html-mode")&&(g(this).html(g(this).text()),g(this).attr("contenteditable",!0),g(this).data("wysiwyg-html-mode",!1)),!0===t&&g(this).parent().is("form")){var e=g(this).html;if(g(e).has("img").length){var n=g("img",g(e)),a=[],o=g(this).parent();g.each(n,function(t,e){g(e).attr("src").match(/^data:image\/.*$/)&&(a.push(n[t]),g(o).prepend("<input value='"+g(e).attr("src")+"' type='hidden' name='postedimage/"+t+"' />"),g(e).attr("src","postedimage/"+t))})}}var i=g(this).html();return i&&i.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},g.fn.wysiwyg=function(t){var n,a,o,r=this,l=function(){a.activeToolbarClass&&g(a.toolbarSelector).find(o).each(function(){var t=g(this).data(a.commandRole).split(" "),e=t[0];1<t.length&&document.queryCommandEnabled(e)&&document.queryCommandValue(e)===t[1]?g(this).addClass(a.activeToolbarClass):1===t.length&&document.queryCommandEnabled(e)&&document.queryCommandState(e)?g(this).addClass(a.activeToolbarClass):g(this).removeClass(a.activeToolbarClass)})},i=function(t,e){var n=t.split(" "),a=n.shift(),o=n.join(" ")+(e||""),i=t.split("-");1===i.length?document.execCommand(a,!1,o):"format"===i[0]&&2===i.length&&document.execCommand("formatBlock",!1,i[1]),r.trigger("change"),l()},e=function(t){g.each(t,function(t,e){r.keydown(t,function(t){r.attr("contenteditable")&&r.is(":visible")&&(t.preventDefault(),t.stopPropagation(),i(e))}).keyup(t,function(t){r.attr("contenteditable")&&r.is(":visible")&&(t.preventDefault(),t.stopPropagation())})}),r.keyup(function(){r.trigger("change")})},s=function(){var t,e;return window.getSelection?(t=window.getSelection()).getRangeAt&&t.rangeCount&&(e=t.getRangeAt(0)):document.selection&&(e=document.selection.createRange()),e},d=function(){n=s()},c=function(){var t;if(window.getSelection||document.createRange){if(t=window.getSelection(),n){try{t.removeAllRanges()}catch(e){document.body.createTextRange().select(),document.selection.empty()}t.addRange(n)}}else document.selection&&n&&n.select()},u=function(){if(!0!==g(r).data("wysiwyg-html-mode")){var t=g(r).html(),e=g("<pre />");g(e).append(document.createTextNode(t)),g(e).attr("contenteditable",!0),g(r).html(" "),g(r).append(g(e)),g(r).attr("contenteditable",!1),g(r).data("wysiwyg-html-mode",!0),g(e).focus()}else g(r).html(g(r).text()),g(r).attr("contenteditable",!0),g(r).data("wysiwyg-html-mode",!1),g(r).focus()},m=function(t){r.focus(),g.each(t,function(t,e){/^image\//.test(e.type)?g.when(y(e)).done(function(t){i("insertimage",t),r.trigger("image-inserted")}).fail(function(t){a.fileUploadError("file-reader",t)}):a.fileUploadError("unsupported-file-type",e.type)})},h=function(t,e){c(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",!1,e||"transparent"),d(),t.data(a.selectionMarker,e)},f=function(t,e){t.find(o).click(function(){c(),r.focus(),"html"===g(this).data(e.commandRole)?u():i(g(this).data(e.commandRole)),d()}),t.find("[data-toggle=dropdown]").click(c),t.find("input[type=text][data-"+e.commandRole+"]").on("webkitspeechchange change",function(){var t=this.value;this.value="",c(),t&&(r.focus(),i(g(this).data(e.commandRole),t)),d()}).on("focus",function(){var t=g(this);t.data(e.selectionMarker)||(h(t,e.selectionColor),t.focus())}).on("blur",function(){var t=g(this);t.data(e.selectionMarker)&&h(t,!1)}),t.find("input[type=file][data-"+e.commandRole+"]").change(function(){c(),"file"===this.type&&this.files&&0<this.files.length&&m(this.files),d(),this.value=""})},p=function(){r.on("dragenter dragover",!1).on("drop",function(t){var e=t.originalEvent.dataTransfer;t.stopPropagation(),t.preventDefault(),e&&e.files&&0<e.files.length&&m(e.files)})};return a=g.extend(!0,{},g.fn.wysiwyg.defaults,t),o="a[data-"+a.commandRole+"],button[data-"+a.commandRole+"],input[type=button][data-"+a.commandRole+"]",e(a.hotKeys),""!==g(this).attr("placeholder")&&(g(this).addClass("placeholderText"),g(this).html(g(this).attr("placeholder")),g(this).bind("focus",function(){""!==g(this).attr("placeholder")&&g(this).text()===g(this).attr("placeholder")&&(g(this).removeClass("placeholderText"),g(this).html(""))}),g(this).bind("blur",function(){""!==g(this).attr("placeholder")&&""===g(this).text()&&(g(this).addClass("placeholderText"),g(this).html(g(this).attr("placeholder")))})),a.dragAndDropImages&&p(),f(g(a.toolbarSelector),a),r.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){d(),l()}),g(window).bind("touchend",function(t){var e=r.is(t.target)||0<r.has(t.target).length,n=s();n&&n.startContainer===n.endContainer&&n.startOffset===n.endOffset&&!e||(d(),l())}),this},g.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(t,e){console.log("File upload error",t,e)}}}(window.jQuery);